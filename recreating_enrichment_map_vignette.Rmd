---
title: "recreating_enrichment_map_tut_with_RCy3"
author: "Julia Gustavsen"
date: "May 24, 2016"
output: 
    html_document:
      keep_md: true
      number_sections: yes
      theme: cerulean
      toc: yes
      toc_depth: 6   
---

# Purpose: 

* Recreating tutorials from Bader lab (link) using Rcy3 and cytoscape.
* creating functions using RCy3 that make it easy to use Enrichment Map


```{r}
library(RCy3)
library(httr)
library(RJSONIO)

```

* Make sure cytoscape is open!

## Reference for the API

found this page which is helpful for the api:

http://idekerlab.github.io/cyREST/#1637304040

## Finding command names available in Cytoscape using R

Finally found: 

http://localhost:1234/v1/commands

Which gives the same as when you type `help` in the Command Line Dialog in cytoscape

```{r}
## create function to get command names for available plugins from Cytoscape
setGeneric ('getCommandNames', 
            signature='obj',
            function(obj) standardGeneric ('getCommandNames'))

setMethod('getCommandNames',
          'CytoscapeConnectionClass',
          function(obj) { 
            request.uri <- paste(obj@uri,
                                 pluginVersion(obj),
                                 "commands",
                                 sep="/")
            request.res <- GET(url=request.uri)
            
            available.commands <- unlist(strsplit(rawToChar(request.res$content),
                                                  split="\n\\s*"))
            ## to remove "Available namespaces" title
            ## remove the first value
            available.commands <- available.commands[-1]
            return(available.commands) 
          })
```

Test out the function to see what commands are available in Cytoscape
```{r}
cy <- CytoscapeConnection ()
getCommandNames(cy)
```

### Accessing the commands within Enrichment map?

```{r}
port.number = 1234
base.url = paste("http://localhost:",
                 toString(port.number),
                 "/v1",
                 sep="")
base.url
commands_enrichment_map.uri <- paste(base.url,
                                     "commands/enrichmentmap",
                                     sep="/")

request.res <- GET(url = commands_enrichment_map.uri )
request.res
```

Now try to extend the function to be able to find commands from a specific plugin?

```{r}
## make function to get commands from Enrichment map
setGeneric ('getCommandNamesEnrichmentMap', 
            signature = 'obj',
            function(obj) standardGeneric ('getCommandNamesEnrichmentMap'))

setMethod('getCommandNamesEnrichmentMap',
          'CytoscapeConnectionClass',
          function(obj) { 
            request.uri <- paste(obj@uri,
                                 pluginVersion(obj),
                                 "commands/enrichmentmap",
                                 sep = "/")
            request.res <- GET(url = request.uri)
            
            available.commands <- unlist(strsplit(rawToChar(request.res$content),
                                                  split = "\n\\s*"))
            ## remove "Available commands" title
            available.commands <- available.commands[-1]
            return(available.commands) })

cy <- CytoscapeConnection ()
str(getCommandNamesEnrichmentMap(cy))

```


### Make a function to look for commands within different plugins.


```{r}
## make function to get commands from Enrichment map
setGeneric ('getCommandsWithinNamespace', 
            signature = 'obj',
            function(obj,
                     namespace) standardGeneric ('getCommandsWithinNamespace'))

setMethod('getCommandsWithinNamespace',
          'CytoscapeConnectionClass',
          function(obj,
                   namespace) { 
            request.uri <- paste(obj@uri,
                                 pluginVersion(obj),
                                 "commands",
                                 namespace,
                                 sep = "/")
            request.res <- GET(url = request.uri)
            
            available.commands <- unlist(strsplit(rawToChar(request.res$content),
                                                  split = "\n\\s*"))
            ## remove "Available commands" title
            available.commands <- available.commands[-1]
            return(available.commands) })
```

Test out using different namespaces
```{r}
cy <- CytoscapeConnection ()
str(getCommandsWithinNamespace(cy, "enrichmentmap"))
getCommandsWithinNamespace(cy, "layout")
getCommandsWithinNamespace(cy, "cluster")
getCommandsWithinNamespace(cy, "network")
```


## Enrichment map stuff

### For reference list of arguments for EnrichmentMap "build"
```help enrichmentmap build```
analysisType=<ListSingleSelection GSEA|generic|DAVID/BiNGO/Great)>: Analysis Type
classDataset1=<File>: Classes
classDataset2=<File>: Classes
coeffecients=<ListSingleSelection (OVERLAP|JACCARD|COMBINED)>: Similarity Coeffecient
enrichments2Dataset1=<File>: Enrichments 2
enrichments2Dataset2=<File>: Enrichments 2
enrichmentsDataset1=<File>: Enrichments
enrichmentsDataset2=<File>: Enrichments
expressionDataset1=<File>: Expression
expressionDataset2=<File>: Expression
gmtFile=<File>: GMT
phenotype1Dataset1=<String>: Phenotype1
phenotype1Dataset2=<String>: Phenotype1
phenotype2Dataset1=<String>: Phenotype2
phenotype2Dataset2=<String>: Phenotype2
pvalue=<Double>: P-value Cutoff
qvalue=<Double>: FDR Q-value Cutoff
ranksDataset1=<File>: Ranks
ranksDataset2=<File>: Ranks
similaritycutoff=<Double>: Similarity Cutoff

### For reference list of arguments for EnrichmentMap gseabuild
```help enrichmentmap gseabuild``` at Cytoscape command line
enrichmentmap gseabuild arguments:
combinedconstant=<Double>: combinedconstant
edbdir=<String>: edbdir
edbdir2=<String>: edbdir2
expressionfile=<String>: expressionfile
expressionfile2=<String>: expressionfile2
overlap=<Double>: overlap
pvalue=<Double>: P-value Cutoff
qvalue=<Double>: FDR Q-value Cutoff
similaritymetric=<ListSingleSelection (OVERLAP|JACCARD|COMBINED)>: similaritymetric


```{r}
setGeneric ('getEnrichmentMapCommands', 
	signature='obj', function(obj) standardGeneric ('getEnrichmentMapCommands'))
setGeneric ('getEnrichmentMapNameMapping',	
	signature='obj', function(obj) standardGeneric ('getEnrichmentMapNameMapping'))
setGeneric ('getEnrichmentMapCommandsNames',	
	signature='obj', function(obj, layout.name) standardGeneric ('getEnrichmentMapCommandsNames'))

getCommandNamesEnrichmentMap(cy)
```

```{r}
## need to specify which one would be most useful here? build or gseabuild or just make stuff for both?
setMethod('getEnrichmentMapNameMapping',
          'CytoscapeConnectionClass', 
    function(obj) {
        layout.names <- getCommandNamesEnrichmentMap(obj)
        layout.full.names <- c()
        
        # get the English/full name of a layout
        for (layout.name in layout.names){
            request.uri <- paste(obj@uri,
                                 pluginVersion(obj),
                                 "commands/enrichmentmap",
                                 as.character(layout.name),
                                 sep="/")
            request.res <- GET(url = request.uri)
            
   layout.property.names <- unlist(strsplit(rawToChar(request.res$content),
                                                  split = "\n\\s*"))
            ## how to remove "Available commands ..."?
            ## not happy with this
            layout.property.names <- layout.property.names[-1]
        }
return(layout.property.names)
})
## END getLayoutNameMapping

getEnrichmentMapNameMapping(cy)            
            
#http://localhost:1234/v1/commands/enrichmentmap/build/

setMethod('getEnrichmentMapCommandsNames',
          'CytoscapeConnectionClass', 
          function(obj,
                   layout.name) {
            request.uri <- paste(obj@uri,
                                 pluginVersion(obj),
                                 "commands/enrichmentmap",
                                 as.character(layout.name),
                                 sep="/")
            request.res <- GET(url=request.uri)
            
            layout.property.names <-unlist(strsplit(rawToChar(request.res$content),
                                                    split = "\n\\s*"))
            ## how to remove "Available commands ..."?
            ## not happy with this
            layout.property.names <- layout.property.names[-1]
            
            return(layout.property.names)
            
          })## END getEnrichmentMapCommandsNames

getEnrichmentMapCommandsNames(cy, "build")
getEnrichmentMapCommandsNames(cy, "gseabuild")
```

Trying to figure out how to send data to the cytoscape network


```{r}

request.uri <- paste(cy@uri,
                     pluginVersion(cy),
                     "commands/enrichmentmap",
                     as.character(layout.name),
                     sep = "/")

## with this one you need to use a GET request and it should be in the form of a query, not a json list. 
# request.res <- PUT(url = request.uri,
#                    body = new.property.value.list.JSON,
#                    encode = "json")
# request.res    
## gives 405 response...which means not allowed. 
```


```{r}
getEnrichmentMapCommandsNames(cy,"build")
```

```{r}
enrichmentmap.url <- paste(base.url,
                           "commands",
                           "enrichmentmap",
                           "build",
                           sep="/") 

## something to deal with is that you cannot use relative paths in this, it needs to be absolute path
path_to_file="/home/julia_g/windows_school/gsoc/EM-tutorials-docker/notebooks/data/"

enr_file = paste(path_to_file,
                 "gprofiler_results_mesenonly_ordered_computedinR.txt",
                 sep="")
```

```{r}
#' Runs Enrichment Map with a list of parameters.
#'
#' @param object Cytoscape network where Enrichment Map is run via RCy3 
#' @param 
#' @return An enrichmentMap 
#'
#' @concept RCy3
#' @export
#' 
#' @importFrom methods setGeneric

setGeneric('setEnrichmentMapProperties', 
            signature='obj',
            function(obj,
                     layout.name,
                     properties.list, 
                     copy.graph.to.R = FALSE) standardGeneric('setEnrichmentMapProperties')
           )

setMethod('setEnrichmentMapProperties',
          'CytoscapeConnectionClass', 
          function(obj,
                   layout.name,
                   properties.list, 
                   copy.graph.to.R = FALSE) {
            all.possible.props <- getEnrichmentMapCommandsNames(obj,
                                                                layout.name)
            if (all(names(properties.list) %in% all.possible.props) == FALSE) {
              print('You have included a name which is not in the commands')
              stderr ()
            } else {
              request.uri <- paste(obj@uri,
                                   pluginVersion(obj),
                                   "commands/enrichmentmap",
                                   as.character(layout.name),
                                   sep = "/")
              
              request.res <- GET(url = request.uri,
                                 query = properties.list)
              if (request.res$status == 200){
                print("Successfully built the EnrichmentMap.")
                stdout ()
                resource.uri <- paste(cy@uri,
                                      pluginVersion(cy),
                                      "networks",
                                      sep="/")
                request.res <- GET(resource.uri)
                # SUIDs list of the existing Cytoscape networks	
                cy.networks.SUIDs <- fromJSON(rawToChar(request.res$content))
                # most recently made enrichment map will have the highest SUID
                cy.networks.SUIDs.last <- max(cy.networks.SUIDs)
                
                res.uri.last <- paste(cy@uri,
                                      pluginVersion(cy),
                                      "networks",
                                      as.character(cy.networks.SUIDs.last),
                                      sep="/")
                result <- GET(res.uri.last)
                net.name <- fromJSON(rawToChar(result$content))$data$name
              
                if (copy.graph.to.R){
                  connect_EM_to_R_session <- existing.CytoscapeWindow (net.name,
                                                  copy.graph.from.cytoscape.to.R=TRUE)
                                 print(paste0("Cytoscape window",
                            net.name,
                            " successfully connected to R session and graph copied to R."))
                } 
                else{
               connect_EM_to_R_session <- existing.CytoscapeWindow (net.name,
                                                  copy.graph.from.cytoscape.to.R=FALSE) 
               print(paste0("Cytoscape window",
                            net.name,
                            " successfully connected to R session."))
                }
               
               
              } else {
                print("Something went wrong. Unable to build EnrichmentMap")
                stderr ()
              }
              invisible(request.res)
            }
            return(connect_EM_to_R_session)
          }) 

em_params <- list(analysisType = "generic",
                  enrichmentsDataset1 = enr_file,
                  pvalue = "1.0",
                  qvalue = "0.00001",
                  #expressionDataset1 = exp_file, 
                  similaritycutoff = "0.25",
                  coeffecients = "JACCARD")
## so no graph is returned, just the connection to the graph
new <- setEnrichmentMapProperties(cy, "build", em_params)

saveImage(new,
          "test_EM_new",
          "png",
          scale=4)
print(noa.names(getGraph(new)))
 layoutNetwork(new,
                  'grid')
saveNetwork(new, "test_EM")    
new@graph

## so almost here like you need to get the window returned here. 
## need a function to determine the suid of the network made. 
## how to get the name of the graph made??
## how can I then manipulate it?

new2 <- setEnrichmentMapProperties(cy,
                                   "build",
                                   em_params,
                                   copy.graph.to.R = TRUE)
print(noa.names(getGraph(new2)))
nodeData(new2@graph)

list_of_windows <- getWindowList(cy)
list_of_windows
## last created and then use that to connect to that window
## hard because suids are just given however?
		resource.uri <- paste(cy@uri,
		                      pluginVersion(cy),
		                      "networks",
		                      sep="/")
		request.res <- GET(resource.uri)
		# SUIDs list of the existing Cytoscape networks	
		cy.networks.SUIDs <- fromJSON(rawToChar(request.res$content))
		# most recently made enrichment map will have the highest SUID
		cy.networks.SUIDs.last <- max(cy.networks.SUIDs)
		
		res.uri.last <- paste(cy@uri,
		                      pluginVersion(cy),
		                      "networks",
		                      as.character(cy.networks.SUIDs.last),
		                      sep="/")
			result <- GET(res.uri.last)
			net.name <- fromJSON(rawToChar(result$content))$data$name

## here!!		
## so the suids seem to increase in number as they are made. ## so it is a matter of extracting them and then getting hte name and linking up to an existing window!

getWindowList(cy)
## how do I connect to that window??
getWindowID(cy,net.name)

## object needs to be a CytoscapeWindowClass object
## connect to existing window....
test_existing_window <- existing.CytoscapeWindow (net.name,
                                                  copy.graph.from.cytoscape.to.R=FALSE)

saveImage(test_existing_window,
          "test_EM_new",
          "png",
          scale=4)
```

![](./test_EM_new.png)

```{r}

enrichmentmap.url <- paste(base.url,
                           "commands",
                           "enrichmentmap",
                           "build",
                           sep="/") 

path_to_file="/home/julia_g/windows_school/gsoc/EM-tutorials-docker/notebooks/data/"

enr_file = paste(path_to_file,"gprofiler_results_mesenonly_ordered_computedinR.txt",sep="")

em_params <- list(analysisType = "generic",
                  enrichmentsDataset1 =enr_file,
                  pvalue="1.0",
                  qvalue="0.00001",
                  #expressionDataset1 = exp_file, 
                  similaritycutoff="0.25",
                  coeffecients="JACCARD")

response <- GET(url=enrichmentmap.url,
                query=em_params)
response$url

```

## Next steps

- Verify that I have made these functions correctly for use in S4 framework
- Clean up the use of the functions
- EM with two inputs.- see tutorial for ideas
