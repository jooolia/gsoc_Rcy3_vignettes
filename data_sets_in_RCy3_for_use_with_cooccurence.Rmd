---
title: "data_sets_in_RCy3"
author: "Julia Gustavsen"
date: "May 24, 2016"
output: 
    html_document:
      keep_md: true
      number_sections: yes
      theme: cerulean
      toc: yes
      toc_depth: 6 
---

```{r, message=FALSE}
library(RCy3)
library(igraph)
library(RJSONIO)
library(reshape2)
library(dplyr)
library(RColorBrewer)
```

What about a small subset of the human gut data? what about the Faust lab?

http://onlinelibrary.wiley.com/doi/10.15252/msb.20156272/pdf

Ok finally the idea is that I can have one with made up data and then I can use the Tara Oceans data to look at another vignette. 

Let's just make it up so it doesn't depend on anything for now...


```{r}
cy <- CytoscapeConnection ()
deleteAllWindows(cy)

## processed in "inst/data-raw/"
prok_vir_cor <- read.delim("./data/virus_prok_cor.tsv")

graph_vir_prok <- simplify(graph.data.frame(prok_vir_cor,
                               directed=FALSE))
```

need to find a way to send igraphs to cytoscape via Rcy3 too. 

Ways to set the layout...
```{r}

cy <- CytoscapeConnection()
hlp <-getLayoutNames(cy)
# getLayoutPropertyNames(cy, hlp[18])
# Apply values to some of the properties and plot the layout
# setLayoutProperties (gDCW,
#                      hlp[18],
#                      list (edge_attribute = 'similarity', iterations = 1000))
# layoutNetwork(gDCW, hlp[18])
# 
# # Now, we can define our own default color/size scheme
# setDefaultBackgroundColor(gDCW, '#FFFFFF')
# setDefaultEdgeColor(gDCW, '#CDC9C9')
# setDefaultEdgeLineWidth(gDCW, 4)
# setDefaultNodeBorderColor(gDCW, '#000000')
# setDefaultNodeBorderWidth(gDCW, 3)
# setDefaultNodeShape(gDCW, 'ellipse')
# setDefaultNodeColor(gDCW, '#87CEFA')
# setDefaultNodeSize(gDCW, 60)
# setDefaultNodeFontSize(gDCW, 20)
# setDefaultNodeLabelColor(gDCW, '#000000')
# 
# # And we can replot it 
# redraw(gDCW)    
```


## read in data from the taxnomic stuff

```{r}
phage_id_affiliation <-read.delim("./data/phage_ids_with_affiliation.tsv")

bac_id_affi <- read.delim("./data/prok_tax_from_silva.tsv")
## then need to add to the node data frames...
```

### Get the network in a mode to send to Cytoscape

```{r}
genenet.nodes <- as.data.frame(vertex.attributes(graph_vir_prok))

## ids do not match for the phage ids 
phage_id_affiliation$first_sheet.Phage_id_network <- gsub("-",
                                                          "_",
                                                          phage_id_affiliation$first_sheet.Phage_id_network)

## not all have classification, so create empty columns
## before had NA but was worried it was messing up the setting of attributes.
genenet.nodes$phage_aff <- rep("test", nrow(genenet.nodes))
genenet.nodes$Tax_order <- rep("test", nrow(genenet.nodes))
genenet.nodes$Tax_subfamily <- rep("test", nrow(genenet.nodes))
str(genenet.nodes)
for (row in seq_along(1:nrow(genenet.nodes))){
  if (genenet.nodes$name[row] %in% phage_id_affiliation$first_sheet.Phage_id_network){
    aff_to_add <- unique(subset(phage_id_affiliation,
              first_sheet.Phage_id_network == genenet.nodes$name[row],
              select = c(phage_affiliation,
                         Tax_order,
                         Tax_subfamily)))
    
    genenet.nodes$phage_aff[row] <- as.character(aff_to_add$phage_affiliation)
    genenet.nodes$Tax_order[row] <- as.character(aff_to_add$Tax_order)
    genenet.nodes$Tax_subfamily[row] <- as.character(aff_to_add$Tax_subfamily)
  }
}

str(genenet.nodes)

## do the same for proks

genenet.nodes$prok_king <- rep("test", nrow(genenet.nodes))
genenet.nodes$prok_tax_phylum <- rep("test", nrow(genenet.nodes))
genenet.nodes$prok_tax_class <- rep("test", nrow(genenet.nodes))

for (row in seq_along(1:nrow(genenet.nodes))){
  if (genenet.nodes$name[row] %in% bac_id_affi$Accession_ID){
     aff_to_add <- unique(subset(bac_id_affi,
              Accession_ID == as.character(genenet.nodes$name[row]),
              select = c(Kingdom,
                         Phylum,
                         Class)))
    
    genenet.nodes$prok_king[row] <- as.character(aff_to_add$Kingdom)
    genenet.nodes$prok_tax_phylum[row] <- as.character(aff_to_add$Phylum)
    genenet.nodes$prok_tax_class[row] <- as.character(aff_to_add$Class)
  }
}

genenet.edges <- data.frame(as_edgelist(graph_vir_prok))
names(genenet.edges) <- c("name.1",
                          "name.2")
genenet.edges$Weight <- edge_attr(graph_vir_prok)[[1]]
str(genenet.edges)
str(genenet.nodes)

genenet.edges$name.1 <- as.character(genenet.edges$name.1)
genenet.edges$name.2 <- as.character(genenet.edges$name.2)
genenet.nodes$name <- as.character(genenet.nodes$name)

## works if I load the source from the cyplot Branch of Rcy3
ug <- cyPlot(genenet.nodes,genenet.edges)

.rcyEdgeNames = function(g) 
{
   nodes.list = graph::edges(g)
   result = c()
   for(source.node in names(nodes.list)) {
      target.nodes = nodes.list[[source.node]]
    
   if(length(target.nodes) == 0) {
      next;
   }
   for(target.node in target.nodes) {
      tilde.edge.name = sprintf('%s~%s', source.node, target.node) 
      result = c(result, tilde.edge.name)
      } # for target.node
   } # for source.node
   
   return(result)
}
## ok this was hacked together a bit. Not sending the edges to cytoscape yet


```

### Send network to Cytoscape

```{r}
cw <- CytoscapeWindow("Tara oceans",
                      graph=ug,
                      overwriteWindow = TRUE)
displayGraph(cw)
redraw(cw)
layoutNetwork(cw)

selectNodes(cw,
            'ph_500') # selects specific nodes
selectNodes(cw,
            'EF571982')
getSelectedNodes(cw)
families_to_colour <- c(" Podoviridae",
                        " Siphoviridae",
                        " Myoviridae")
node.colour = c('#00AA00',
                '#00FF00',
                '#AAAAAA')
setNodeColorRule(cw,
                 'Tax_subfamily',
                 families_to_colour,
                 node.colour,
                 "lookup",
                 default.color='#AA0000')

families_to_colour <- unique(genenet.nodes$prok_tax_phylum)
## remove "test"
families_to_colour <- families_to_colour[!families_to_colour %in% "test"]
node.colour <- brewer.pal(length(families_to_colour),
                          "Set3")

setNodeColorRule(cw,
                 'prok_tax_phylum',
                 families_to_colour,
                 node.colour,
                 "lookup",
                 default.color='#ffffff')
## works!

## set shape to be virus or prok
shapes_for_nodes <- c('DIAMOND')

## so want to grep for ph
phage_names <- grep("ph_", genenet.nodes$name, value=TRUE)
## here I want to search for something...
noa.names (cw@graph)
setNodeShapeRule(cw,
                 "label",
                 phage_names,
                 shapes_for_nodes)
## cool that worked!!
```
