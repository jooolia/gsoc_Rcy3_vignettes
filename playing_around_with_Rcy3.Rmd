---
title: "playing_around_with_RCy3_functions"
author: "Julia Gustavsen"
date: "May 24, 2016"
output: 
    html_document:
      keep_md: true
      number_sections: yes
      theme: cerulean
      toc: yes
      toc_depth: 6        
---

# Purpose

Testing out some ways to develop functions that could be used in R with RCy3 to access Cytoscape plugins

# Sandbox

```{r}
library(RCy3)
library(RJSONIO)
library(httr)
```

## Connection to Cytoscape 

```{r}
CytoscapeConnection() # checks for the connection
CytoscapeWindow("test", overwriteWindow = TRUE) # creates empty window in Cytoscape
existing.CytoscapeWindow("new") # throws an error if it does not exist yet
existing.CytoscapeWindow("test") # The constructor for the CytoscapeWindowClass, used when Cytoscape already contains 
## and displays a network. COuld be useful. 

#check.cytoscape.plugin.version() ## doesn't work with loading the regular library. or in dev. Seems to work a bit more if loaded separately

```

## Visualizing REST urls

```{r}
port.number = 1234
base.url = paste("http://localhost:",
                 toString(port.number),
                 "/v1", sep="")
base.url


```

## Basic cytoscape info

```{r}
version.url = paste(base.url,
                    "version",
                    sep="/")

cytoscape.version = GET(version.url)
cy.version = fromJSON(rawToChar(cytoscape.version$content))
cy.version

basic_info = GET(base.url)

basic_info = fromJSON(rawToChar(basic_info$content))
basic_info
```


## List of networks currently available

```{r}
## lists networks 
network.url = paste(base.url, "networks", sep="/")
network.url
```

## Code from RCy3 on getLayoutNames

Help to figure out how to access the commands for manipulating networks n Cytoscape via plugins. 

standardGeneric() is like the S3 UseMethod()
```{r}
## lifted from RCy3 code

setMethod('getLayoutNames',
          'CytoscapeConnectionClass', 
          function(obj) {
            request.uri <- paste(obj@uri,
                                 pluginVersion(obj),
                                 "apply/layouts",
                                 sep="/")
            request.res <- GET(url=request.uri)
            
            available.layouts <- unname(fromJSON(rawToChar(request.res$content)))
            return(available.layouts)
          })
```

To look at the current parameters of one type of attribute: 

http://localhost:1234/v1/apply/layouts/attribute-circle/parameters

Will come back later to find the function that RCy3 uses to apply parameters

```{r}
cy <- CytoscapeConnection ()
getLayoutNames (cy)
```

## URLs used to test out API calls

http://localhost:1234/v1/networks - gives list of networks

http://localhost:1234/v1/networks/13633 - gives json formatted view of network

http://localhost:1234/v1/networks/13633/tables - shows all networks?

http://localhost:1234/v1/networks/13633/tables/defaultnode

http://localhost:1234/v1/networks/13633/tables/defaultnode/rows

http://localhost:1234/v1/networks/13633/tables/defaultedge

http://localhost:1234/v1/networks/13633/tables/defaultedge/rows

http://localhost:1234/v1/apply/styles

http://localhost:1234/v1/networks.names/ - returns json list

http://localhost:1234/v1/tables/count/

## Reference for the API

found this page which is helpful for the api:

http://idekerlab.github.io/cyREST/#1637304040

## Finding command names available in Cytoscape using R

Finally found: 

http://localhost:1234/v1/commands

Which gives the same as when you type `help` in the Command Line Dialog in cytoscape

```{r}
## create function to get command names from Cytoscape
setGeneric ('getCommandNames', 
            signature='obj',
            function(obj) standardGeneric ('getCommandNames'))

setMethod('getCommandNames',
          'CytoscapeConnectionClass',
          function(obj) { 
            request.uri <- paste(obj@uri,
                                 pluginVersion(obj),
                                 "commands",
                                 sep="/")
            request.res <- GET(url=request.uri)
            
            available.commands <- unlist(strsplit(rawToChar(request.res$content),
                                                  split="\n\\s*"))
            ## how to remove "Available namespaces"?
            ## will remove the first value,
            ## but feels a bit hacky
            ## not happy with this
            available.commands <- available.commands[-1]
            return(available.commands) })
```

Test out the function to see the available commands in Cytoscape
```{r}
cy <- CytoscapeConnection ()
getCommandNames(cy)
```

### Can I easily access the commands within Enrichment map?

```{r}
commands_enrichment_map.uri <- paste(base.url, "commands/enrichmentmap", sep="/")
request.res <- GET(url = commands_enrichment_map.uri )
request.res
```

Now try to extend this to find commands from a specific plugin?
Does it make sense to make a specifc class for S4 for these things? I need to keep learning about this.

```{r}
## make function to get commands from Enrichment map
setGeneric ('getCommandNamesEnrichmentMap', 
            signature = 'obj', function(obj) standardGeneric ('getCommandNamesEnrichmentMap'))

setMethod('getCommandNamesEnrichmentMap',
          'CytoscapeConnectionClass',
          function(obj) { 
            request.uri <- paste(obj@uri,
                                 pluginVersion(obj),
                                 "commands/enrichmentmap",
                                 sep = "/")
            request.res <- GET(url = request.uri)
            
            available.commands <- unlist(strsplit(rawToChar(request.res$content),
                                                  split = "\n\\s*"))
            ## how to remove "Available commands ..."?
            ## not happy with this
            available.commands <- available.commands[-1]
            return(available.commands) })

cy <- CytoscapeConnection ()
str(getCommandNamesEnrichmentMap(cy))

```

Could try to find names within a specific namespace...make a function to do that?


```{r}
## make function to get commands from Enrichment map
setGeneric ('getCommandsWithinNamespace', 
            signature = 'obj',
            function(obj,
                     namespace) standardGeneric ('getCommandsWithinNamespace'))

setMethod('getCommandsWithinNamespace',
          'CytoscapeConnectionClass',
          function(obj,
                   namespace) { 
            request.uri <- paste(obj@uri,
                                 pluginVersion(obj),
                                 "commands",
                                 namespace,
                                 sep = "/")
            request.res <- GET(url = request.uri)
            
            available.commands <- unlist(strsplit(rawToChar(request.res$content),
                                                  split = "\n\\s*"))
            ## how to remove "Available commands ..."?
            ## not happy with this
            available.commands <- available.commands[-1]
            return(available.commands) })
```

Test out using different namespaces
```{r}
cy <- CytoscapeConnection ()
str(getCommandsWithinNamespace(cy, "enrichmentmap"))
getCommandsWithinNamespace(cy, "layout")
getCommandsWithinNamespace(cy, "cluster")
getCommandsWithinNamespace(cy, "network")
```


## Enrichment map stuff

### help enrichmentmap build
enrichmentmap build arguments:
analysisType=<ListSingleSelection GSEA|generic|DAVID/BiNGO/Great)>: Analysis Type
classDataset1=<File>: Classes
classDataset2=<File>: Classes
coeffecients=<ListSingleSelection (OVERLAP|JACCARD|COMBINED)>: Similarity Coeffecient
enrichments2Dataset1=<File>: Enrichments 2
enrichments2Dataset2=<File>: Enrichments 2
enrichmentsDataset1=<File>: Enrichments
enrichmentsDataset2=<File>: Enrichments
expressionDataset1=<File>: Expression
expressionDataset2=<File>: Expression
gmtFile=<File>: GMT
phenotype1Dataset1=<String>: Phenotype1
phenotype1Dataset2=<String>: Phenotype1
phenotype2Dataset1=<String>: Phenotype2
phenotype2Dataset2=<String>: Phenotype2
pvalue=<Double>: P-value Cutoff
qvalue=<Double>: FDR Q-value Cutoff
ranksDataset1=<File>: Ranks
ranksDataset2=<File>: Ranks
similaritycutoff=<Double>: Similarity Cutoff

### help enrichmentmap gseabuild
enrichmentmap gseabuild arguments:
combinedconstant=<Double>: combinedconstant
edbdir=<String>: edbdir
edbdir2=<String>: edbdir2
expressionfile=<String>: expressionfile
expressionfile2=<String>: expressionfile2
overlap=<Double>: overlap
pvalue=<Double>: P-value Cutoff
qvalue=<Double>: FDR Q-value Cutoff
similaritymetric=<ListSingleSelection (OVERLAP|JACCARD|COMBINED)>: similaritymetric

```{r}

setGeneric ('getEnrichmentMapCommands', 
	signature='obj', function(obj) standardGeneric ('getEnrichmentMapCommands'))
setGeneric ('getEnrichmentMapNameMapping',	
	signature='obj', function(obj) standardGeneric ('getEnrichmentMapNameMapping'))
setGeneric ('getEnrichmentMapCommandsNames',	
	signature='obj', function(obj, layout.name) standardGeneric ('getEnrichmentMapCommandsNames'))

getCommandNamesEnrichmentMap(cy)

layout.names <- getCommandNamesEnrichmentMap(cy)
layout.full.names <- c()


# get the English/full name of a layout
for (layout.name in layout.names){
  request.uri <- paste(cy@uri,
                       pluginVersion(cy),
                       "commands/enrichmentmap",
                       as.character(layout.name),
                       sep="/")
  request.res <- GET(url=request.uri)

   layout.property.names <- unlist(strsplit(rawToChar(request.res$content),
                                                  split = "\n\\s*"))
            ## how to remove "Available commands ..."?
            ## not happy with this
            layout.property.names <- layout.property.names[-1]

return(layout.property.names)
}
```

```{r}
## need to specify which one would be most useful here? build or gseabuild or just make stuff for both?
setMethod('getEnrichmentMapNameMapping', 'CytoscapeConnectionClass', 
    function(obj) {
        layout.names <- getCommandNamesEnrichmentMap(obj)
        layout.full.names <- c()
        
        # get the English/full name of a layout
        for (layout.name in layout.names){
            request.uri <- paste(obj@uri,
                                 pluginVersion(obj),
                                 "commands/enrichmentmap",
                                 as.character(layout.name),
                                 sep="/")
            request.res <- GET(url=request.uri)
            
   layout.property.names <- unlist(strsplit(rawToChar(request.res$content),
                                                  split = "\n\\s*"))
            ## how to remove "Available commands ..."?
            ## not happy with this
            layout.property.names <- layout.property.names[-1]
        }

return(layout.property.names)
})
## END getLayoutNameMapping

getEnrichmentMapNameMapping(cy)            
            
#http://localhost:1234/v1/commands/enrichmentmap/build/

setMethod('getEnrichmentMapCommandsNames',
          'CytoscapeConnectionClass', 
          function(obj,
                   layout.name) {
            request.uri <- paste(obj@uri,
                                 pluginVersion(obj),
                                 "commands/enrichmentmap",
                                 as.character(layout.name),
                                 sep="/")
            request.res <- GET(url=request.uri)
            
            layout.property.names <-unlist(strsplit(rawToChar(request.res$content),
                                                    split = "\n\\s*"))
            ## how to remove "Available commands ..."?
            ## not happy with this
            layout.property.names <- layout.property.names[-1]
            
            return(layout.property.names)
            
          })## END getEnrichmentMapCommandsNames

getEnrichmentMapCommandsNames(cy, "build")
getEnrichmentMapCommandsNames(cy, "gseabuild")
```

Trying to figure out how to send data to the cytoscape network


```{r}

request.uri <- paste(cy@uri,
                     pluginVersion(cy),
                     "commands/enrichmentmap",
                     as.character(layout.name),
                     sep = "/")

## with this one you need to use a GET request and it should be in the form of a query, not a json list. 
request.res <- PUT(url = request.uri,
                   body = new.property.value.list.JSON,
                   encode = "json")
request.res    
## gives 405 response...which means not allowed. 
```


```{r}
getEnrichmentMapCommandsNames(cy,"build")
```

```{r}
enrichmentmap.url <- paste(base.url,
                           "commands",
                           "enrichmentmap",
                           "build",
                           sep="/") 

## something to deal with is that you cannot use relative paths in this, it needs to be absolute path
path_to_file="/home/julia_g/windows_school/gsoc/EM-tutorials-docker/notebooks/data/"

enr_file = paste(path_to_file,
                 "gprofiler_results_mesenonly_ordered_computedinR.txt",
                 sep="")

#' Runs Enrichment Map with a list of parameters.
#'
#' @param object Cytoscape network where Enrichment Map is run via RCy3 
#' @param 
#' @return An enrichmentMap 
#'
#' @concept RCy3
#' @export
#' 
#' @importFrom methods setGeneric

setGeneric('setEnrichmentMapProperties', 
            signature='obj',
            function(obj,
                     layout.name,
                     properties.list) standardGeneric('setEnrichmentMapProperties')
           )

setMethod('setEnrichmentMapProperties',
          'CytoscapeWindowClass', 
          
          function(obj,
                   layout.name,
                   properties.list) {
            all.possible.props <- getEnrichmentMapCommandsNames(obj,
                                                         layout.name)
              if (all(names(properties.list) %in% all.possible.props) == FALSE) {
                print('You have included a name which is not in the commands')
                      stderr ()
              } else {
                request.uri <- paste(obj@uri,
                     pluginVersion(obj),
                     "commands/enrichmentmap",
                     as.character(layout.name),
                     sep = "/")

                request.res <- GET(url = request.uri,
                                   query = properties.list)
                if (request.res$status == 200){
                  print("Successfully buitl the EnrichmentMap.")
                        stdout ()
                } else {
                  print("Something went wrong. Unable to build EnrichmentMap")
                        stderr ()
                }
                invisible(request.res)
              }
          }) 

em_params <- list(analysisType = "generic",
                  enrichmentsDataset1 = enr_file,
                  pvalue = "1.0",
                  qvalue = "0.00001",
                  #expressionDataset1 = exp_file, 
                  similaritycutoff = "0.25",
                  coeffecients = "JACCARD")

setEnrichmentMapProperties(cy, "build", em_params)
displayGraph(cy)
## does not work because the class is not right
## see line 404 in RCy3.R
saveImage(cy,"test_EM", "pdf", scale=1.0)
saveImage(c2,"test_EM", "png", scale=0.3)

```



```{r}

enrichmentmap.url <- paste(base.url,
                           "commands",
                           "enrichmentmap",
                           "build",
                           sep="/") 

path_to_file="/home/julia_g/windows_school/gsoc/EM-tutorials-docker/notebooks/data/"

enr_file = paste(path_to_file,"gprofiler_results_mesenonly_ordered_computedinR.txt",sep="")

em_params <- list(analysisType = "generic",
                  enrichmentsDataset1 =enr_file,
                  pvalue="1.0",
                  qvalue="0.00001",
                  #expressionDataset1 = exp_file, 
                  similaritycutoff="0.25",
                  coeffecients="JACCARD")

response <- GET(url=enrichmentmap.url,
                query=em_params)
response$url

```

## Next steps

- Examine RCy3 to see what functions I can use to send info (POST) to the commands in Cytoscape. 
- Verify that I have made these functions correctly for use in S4 framework
- Start working through Enrichment map tutorial (or other data?) using these R functions.
- Is it wrong to have variable `available.commands`? Does this mess with S4 stuff? 
- timecourse ideas??